<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultado del Diagn√≥stico</title>
    <link rel="stylesheet" href="/static/styles.css?v=2.4">
</head>
<body>
    <div class="container">
    <!-- Logo SmartSolve en esquina -->
    <img src="/imgs/SmartSolve.jpeg" alt="SmartSolve" class="corner-logo" loading="lazy">

    <!-- Barra de Progreso -->
        <div class="progress-bar">
            <div class="progress-step completed">
                <div class="progress-step-circle">‚úì</div>
                <div class="progress-step-label">Categor√≠a</div>
            </div>
            <div class="progress-step completed">
                <div class="progress-step-circle">‚úì</div>
                <div class="progress-step-label">S√≠ntomas</div>
            </div>
            <div class="progress-step active">
                <div class="progress-step-circle">3</div>
                <div class="progress-step-label">Diagn√≥stico</div>
            </div>
        </div>

        <h1>‚úÖ Resultado del Diagn√≥stico</h1>

        {% if sintomas_mostrados %}
        <div style="margin-top: 30px; margin-bottom: 25px; padding: 20px; background-color: #f8f9fa; border-left: 4px solid var(--primary); border-radius: 10px;">
            <h3 style="margin-top: 0; margin-bottom: 15px; color: var(--primary); font-size: 1.1em;">
                üìã S√≠ntomas considerados:
            </h3>
            <ul style="padding-left: 25px; margin-bottom: 0; list-style: none;">
                {% for pregunta in sintomas_mostrados %}
                <li style="margin-bottom: 8px; position: relative; padding-left: 10px;">
                    <span style="color: var(--primary); position: absolute; left: -15px;">‚ñ™</span>
                    {{ pregunta }}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="resultado">
            <h2>üîç Diagn√≥stico</h2>
            <p style="font-size: 1.05em; line-height: 1.8;">{{ diagnostico }}</p>
        </div>

        <!-- Feedback: ¬øSirvi√≥ la soluci√≥n? -->
        <div id="feedback-section" style="margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 10px; border: 2px solid var(--border);">
            <h3 style="text-align: center; color: var(--primary); margin-bottom: 15px;">¬øLa soluci√≥n te ayud√≥?</h3>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button onclick="enviarFeedback('si')" class="btn" style="flex: 1; max-width: 200px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); margin: 0;">
                    ‚úÖ S√≠, me sirvi√≥
                </button>
                <button onclick="enviarFeedback('no')" class="btn btn-warning" style="flex: 1; max-width: 200px; margin: 0;">
                    ‚ùå No me sirvi√≥
                </button>
            </div>
        </div>

        <!-- Mensaje de agradecimiento (se muestra despu√©s del feedback) -->
        <div id="feedback-gracias" style="display: none; margin-top: 20px; padding: 20px; background-color: rgba(16, 185, 129, 0.1); border: 2px solid #10b981; border-radius: 10px; text-align: center;">
            <h3 style="color: #10b981; margin-bottom: 10px;">‚úÖ ¬°Gracias por tu feedback!</h3>
            <p style="color: #333; margin: 0;">Tu opini√≥n nos ayuda a mejorar el sistema.</p>
        </div>

        <!-- Contacto de soporte (solo si NO sirvi√≥) -->
        <div id="soporte-contacto" style="display: none; margin-top: 20px; padding: 20px; background-color: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; border-radius: 10px;">
            <h3 style="color: #ef4444; margin-bottom: 10px; text-align: center;">üìû Contacta a Soporte T√©cnico</h3>
            <p style="text-align: center; color: #333; margin-bottom: 10px;">
                Lamentamos que la soluci√≥n no haya funcionado. Nuestro equipo t√©cnico puede ayudarte.
            </p>
            <p style="text-align: center; font-size: 1.3em; font-weight: bold; color: #ef4444; margin: 0;">
                {{ numero_soporte }}
            </p>
        </div>

        <!-- Botones de acci√≥n -->
        <button onclick="window.print()" class="btn" style="margin-top: 30px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            üñ®Ô∏è Imprimir Diagn√≥stico
        </button>
        
        <button onclick="copyDiagnostic()" class="btn btn-secondary" style="margin-top: 10px;">
            üìã Copiar al Portapapeles
        </button>

        <a href="/" class="btn" style="margin-top: 10px;">üîÑ Realizar Otro Diagn√≥stico</a>
        <a href="/otro-problema" class="btn btn-secondary" style="margin-top: 10px;">üìù Detallar Otro Problema</a>

        <!-- Mensaje de confirmaci√≥n de copia -->
        <div id="copy-notification" style="display: none; margin-top: 15px; padding: 12px; background-color: rgba(37, 99, 235, 0.10); border: 2px solid var(--primary); border-radius: 8px; color: var(--primary); font-weight: bold; text-align: center;">
            ‚úÖ Diagn√≥stico copiado al portapapeles
        </div>
    </div>

    <!-- Datos para JavaScript (sin sintaxis Jinja dentro del script) -->
    <div id="diagnostic-data" style="display: none;"
         data-diagnostico="{{ diagnostico }}"
         data-sintomas='{% if sintomas_mostrados %}{{ sintomas_mostrados | tojson }}{% else %}[]{% endif %}'
         data-id-diagnostico="{{ id_diagnostico }}">
    </div>

    <script>
    // --- Feedback: S√≠ sirvi√≥ / No sirvi√≥ ---
    function enviarFeedback(respuesta) {
        const dataElement = document.getElementById('diagnostic-data');
        const idDiagnostico = dataElement.getAttribute('data-id-diagnostico');
        
        // Crear FormData para enviar
        const formData = new FormData();
        formData.append('id_diagnostico', idDiagnostico);
        formData.append('feedback', respuesta);
        
        // Enviar feedback al servidor
        fetch('/feedback', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Ocultar botones de feedback
                document.getElementById('feedback-section').style.display = 'none';
                
                // Mostrar mensaje de agradecimiento
                document.getElementById('feedback-gracias').style.display = 'block';
                
                // Si la respuesta fue "no", mostrar contacto de soporte
                if (respuesta === 'no') {
                    document.getElementById('soporte-contacto').style.display = 'block';
                }
            } else {
                alert('Error al guardar feedback: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al enviar feedback. Por favor, intenta nuevamente.');
        });
    }

    // --- Copiar diagn√≥stico al portapapeles ---
    function copyDiagnostic() {
        // Obtener datos del elemento oculto
        const dataElement = document.getElementById('diagnostic-data');
        const diagnostico = dataElement.getAttribute('data-diagnostico');
        const sintomasJson = dataElement.getAttribute('data-sintomas');
        
        // Construir el texto completo del diagn√≥stico
        let textToCopy = "=== DIAGN√ìSTICO DE PC ===\n\n";
        
        try {
            const sintomas = JSON.parse(sintomasJson);
            if (sintomas && sintomas.length > 0) {
                textToCopy += "S√çNTOMAS CONSIDERADOS:\n";
                sintomas.forEach(function(pregunta) {
                    textToCopy += "‚Ä¢ " + pregunta + "\n";
                });
                textToCopy += "\n";
            }
        } catch (e) {
            console.error('Error parsing sintomas:', e);
        }
        
        textToCopy += "DIAGN√ìSTICO:\n" + diagnostico + "\n\n";
        textToCopy += "=========================\n";
        textToCopy += "Generado por Sistema Experto de Diagn√≥stico PC";

        // Copiar al portapapeles
        navigator.clipboard.writeText(textToCopy).then(function() {
            // Mostrar notificaci√≥n de √©xito
            const notification = document.getElementById('copy-notification');
            notification.style.display = 'block';
            
            // Ocultar despu√©s de 3 segundos
            setTimeout(function() {
                notification.style.display = 'none';
            }, 3000);
        }).catch(function(err) {
            alert('Error al copiar: ' + err);
        });
    }

    // Estilos de impresi√≥n
    const style = document.createElement('style');
    style.textContent = `
        @media print {
            body {
                background: white !important;
                padding: 20px;
            }
            .container {
                box-shadow: none !important;
                padding: 0;
            }
            .progress-bar, button, a, #copy-notification {
                display: none !important;
            }
            .resultado {
                border: 2px solid var(--primary);
                page-break-inside: avoid;
            }
        }
    `;
    document.head.appendChild(style);
    </script>
</body>
</html>